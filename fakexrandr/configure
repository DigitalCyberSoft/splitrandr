#!/bin/bash

# 1) Determine xrandr version
IFS="."
XRANDR_VERSION=( $(pkg-config --modversion xrandr) )
if ! [ $? -eq 0 ]; then
	exit 1
fi
echo "XRandR version is ${XRANDR_VERSION[*]}"
unset IFS

# For convenience: Check if Xlib headers are present
pkg-config --exists x11 || exit 1

# 2) Determine path to real xrandr library
# PR #7: Use LD_PRELOAD to prevent self-interference when already installed
REAL_LIBRARY=$(ldconfig -p 2>/dev/null | grep 'libXrandr\.so\.2' | head -n 1 | sed -nre 's/.+=> (.+)/\1/p')
if [ -z "${REAL_LIBRARY}" ]; then
	# Fallback: use ldd on xrandr binary
	REAL_LIBRARY=$(LD_PRELOAD="" ldd $(which xrandr) 2>/dev/null | sed -nre 's/.+libXrandr.so.+=> ([^ ]+).*/\1/p')
fi
echo "The path to the real XRandR library is ${REAL_LIBRARY}"
if [ -z "${REAL_LIBRARY}" ]; then
	echo "ERROR: Could not find libXrandr.so.2"
	exit 1
fi
if echo "${REAL_LIBRARY}" | grep -q local; then
	echo -e "\033[31mWARNING: \033[0m This looks as if you already have fakexrandr installed?!"
	# Try ldconfig first, then fall back to find
	REAL_LIBRARY=$(ldconfig -p 2>/dev/null | grep 'libXrandr\.so\.2' | grep -v local | head -n 1 | sed -nre 's/.+=> (.+)/\1/p')
	if [ -z "${REAL_LIBRARY}" ]; then
		REAL_LIBRARY=$(find /usr/lib /usr/lib64 /lib64 -name 'libXrandr.so.2' 2>/dev/null | grep -v local | head -n 1)
	fi
	if [ -z "${REAL_LIBRARY}" ]; then
		echo "          Aborting: No other candidate was found"
		exit 1
	fi
	echo "          Using ${REAL_LIBRARY} instead."
fi
REAL_LIBRARY_DIR=$(dirname "${REAL_LIBRARY}")

# 3) Determine location for fake xrandr library
# Fedora fix: prefer /usr/local/lib64 on 64-bit systems, avoid CUDA directories
FAKE_LIBRARY_DIRECTORY=
if [ -d /usr/local/lib64 ]; then
	FAKE_LIBRARY_DIRECTORY=/usr/local/lib64
elif [ -d /usr/local/lib ]; then
	FAKE_LIBRARY_DIRECTORY=/usr/local/lib
fi

# Verify it's not the same as the real library dir
if [ "${FAKE_LIBRARY_DIRECTORY}" = "${REAL_LIBRARY_DIR}" ]; then
	FAKE_LIBRARY_DIRECTORY=
fi

# Fallback: search ldconfig paths (excluding CUDA and real library dir)
if [ -z "${FAKE_LIBRARY_DIRECTORY}" ]; then
	LIBRARY_DIRECTORIES=($(ldconfig -v 2>/dev/null | grep -oE '^/[^:]+'))
	CANDIDATES=
	for DIR in ${LIBRARY_DIRECTORIES[@]}; do
		if [ "$DIR" == "${REAL_LIBRARY_DIR}" ]; then
			break
		fi
		CANDIDATES+="$DIR, "
		# Skip CUDA directories
		if echo "$DIR" | grep -qi cuda; then
			continue
		fi
		if echo $DIR | grep -q local; then
			FAKE_LIBRARY_DIRECTORY=$DIR
			break
		fi
	done
fi

if [ -z "${FAKE_LIBRARY_DIRECTORY}" ]; then
	echo
	echo -e "\033[31mERROR:\033[0m Failed to find a suitable directory for the fakeXrandr library"
	echo
	echo "You must place the library into the library search path, in a directory preceeding"
	echo "${REAL_LIBRARY_DIR}. Either add a high-priority directory in /usr/local using the ldconfig"
	echo "mechanism (See /etc/ld.so.conf.d/ on most systems) or manually create config.h."
	echo
	exit 1
fi
echo "The fake library will be installed to ${FAKE_LIBRARY_DIRECTORY}"

cat > config.h <<EOF
/* This file was automatically generated by ./configure */

#define XRANDR_MAJOR ${XRANDR_VERSION[0]}
#define XRANDR_MINOR ${XRANDR_VERSION[1]}
#define XRANDR_PATCH ${XRANDR_VERSION[2]}

#define REAL_XRANDR_LIB "${REAL_LIBRARY}"
#define FAKEXRANDR_INSTALL_DIR "${FAKE_LIBRARY_DIRECTORY}"
EOF

exit 0
